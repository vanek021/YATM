@page "/recipes"

@using YATM.BlazorModels.Recipes;
@using YATM.Components.Shared;
@using YATM.Pages.Recipes.Components;
@using YATM.Services;

@attribute [Authorize]

@inject DatabaseFactory dbFactory

<PageTitle>Рецепты</PageTitle>

<RecipeCreateEditModal @ref="recipeCreateEditModal" Recipe="recipeCreateEdit" OKCallback="OnModalConfirmAsync" />
<ConfirmationModal @ref="deleteConfirmation" OnCancel="CancelDeleting" OnConfirm="@(_ => OnDeleteConfirmedAsync(deleteDraft!.Id))">
    <div>Удалить рецепт "@deleteDraft?.Title"?</div>
</ConfirmationModal>
<Flex Style="padding-bottom: 10px;" Wrap="wrap" Gap="small">
    <div>
        <Button OnClick="OnCreateClickAsync" Icon="@IconType.Outline.Plus">
            Создать
        </Button>
    </div>
    <div style="display: flex; gap: 8px; align-items: center;">
        <Input Placeholder="https://food.ru/recipes/... или https://www.russianfood.com/recipes/..."
               @bind-Value="importUrl"
               Style="width: 420px;" />
        <Button Type="primary"
                Loading="@isImporting"
                OnClick="OnImportClickAsync">
            Импортировать
        </Button>
    </div>
</Flex>
@if (!string.IsNullOrWhiteSpace(importError))
{
    <div style="padding-bottom: 10px; color: #cf1322;">
        @importError
    </div>
}
@if (!string.IsNullOrWhiteSpace(supportedSitesSummary))
{
    <div style="padding-bottom: 10px; color: #8c8c8c; font-size: 12px;">
        Поддерживаемые сайты: @supportedSitesSummary
    </div>
}
<Flex Justify="space-evenly" Wrap="wrap">
    @foreach (var recipe in Recipes)
    {
        <div style="width: 380px; margin:10px;">
            <Card>
                <TitleTemplate>
                    <div>@recipe.Title</div>
                </TitleTemplate>
                <Extra>
                    <Button Icon="@IconType.Outline.Delete" @onclick=@(_ => OnShowDeleteConfirmation(recipe)) />
                    <Button Icon="@IconType.Outline.Edit" @onclick=@(_ => OnEditClickAsync(recipe.Id)) />
                </Extra>
                <Body>
                    @if (!string.IsNullOrWhiteSpace(recipe.SourceSiteName))
                    {
                        <div style="margin-bottom: 8px;">
                            <Tag Color="processing">@recipe.SourceSiteName</Tag>
                            @if (!string.IsNullOrWhiteSpace(recipe.SourceUrl))
                            {
                                <a href="@recipe.SourceUrl" target="_blank" rel="noopener noreferrer">Оригинал</a>
                            }
                        </div>
                    }
                    @((MarkupString)recipe.Content)
                </Body>
            </Card>
        </div>
    }
</Flex>

@code {
    private List<RecipeBlazorModel> Recipes { get; set; } = new();
    private RecipeBlazorModel? recipeCreateEdit;
    private RecipeCreateEditModal? recipeCreateEditModal;
    private RecipeBlazorModel? deleteDraft;
    private ConfirmationModal? deleteConfirmation;
    private string importUrl = string.Empty;
    private bool isImporting;
    private string? importError;
    private List<RecipeImportSourceSiteBlazorModel> supportedImportSites = new();
    private string supportedSitesSummary = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        using (var db = dbFactory.Create())
        {
            var recipeService = db.GetService<RecipeService>();
            supportedImportSites = recipeService.GetSupportedImportSites();
            supportedSitesSummary = string.Join("; ", supportedImportSites
                .Select(site => $"{site.Name} ({string.Join(", ", site.Hosts)})"));
        }

        await GetItemsAsync();
        await base.OnInitializedAsync();
    }

    private void CancelDeleting()
    {
        deleteConfirmation?.Hide();
        deleteDraft = null;
    }

    private async Task GetItemsAsync()
    {
        using var db = dbFactory.Create();
        var recipeService = db.GetService<RecipeService>();
        var appCtx = db.GetService<ApplicationContext>();
        Recipes = await recipeService.GetRecipesByUserAsync(appCtx.CurrentUser);
        StateHasChanged();
    }

    private async Task OnCreateClickAsync()
    {
        recipeCreateEdit = new();
        recipeCreateEditModal!.OpenModal();
    }

    private async Task OnEditClickAsync(long id)
    {
        recipeCreateEdit = Recipes.First(r => r.Id == id);
        recipeCreateEditModal!.OpenModal();
    }

    private void OnShowDeleteConfirmation(RecipeBlazorModel model)
    {
        deleteDraft = model;
        deleteConfirmation?.Show();
    }

    private async Task OnDeleteConfirmedAsync(long id)
    {
        deleteConfirmation?.Hide();

        if (deleteDraft == null)
            return;

        using var db = dbFactory.Create();
        var recipeService = db.GetService<RecipeService>();
        await recipeService.DeleteRecipeAsync(id);

        await GetItemsAsync();
        StateHasChanged();
    }

    private async Task OnModalConfirmAsync()
    {
        using var db = dbFactory.Create();
        var recipeService = db.GetService<RecipeService>();

        if (recipeCreateEdit!.Id == default)
            await recipeService.CreateRecipeAsync(recipeCreateEdit);
        else
            await recipeService.UpdateRecipeAsync(recipeCreateEdit);

        await GetItemsAsync();
        StateHasChanged();
    }

    private async Task OnImportClickAsync()
    {
        importError = null;

        if (string.IsNullOrWhiteSpace(importUrl))
        {
            importError = "Укажите ссылку на рецепт для импорта.";
            return;
        }

        isImporting = true;
        StateHasChanged();

        try
        {
            using var db = dbFactory.Create();
            var recipeService = db.GetService<RecipeService>();
            await recipeService.ImportRecipeAsync(importUrl.Trim());
            importUrl = string.Empty;

            await GetItemsAsync();
        }
        catch (Exception ex)
        {
            importError = ex.Message;
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }
}
